#include <Wire.h>
#include "MAX30105.h"
#include "heartRate.h"
#include <OneWire.h>
#include <DallasTemperature.h>

// MAX30102 sensor
MAX30105 particleSensor;

// DS18B20 temperature sensor
#define ONE_WIRE_BUS 4
OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature sensors(&oneWire);

// Heart rate moving average
#define RATE_SIZE 4
byte rates[RATE_SIZE];
byte rateSpot = 0;
long lastBeat = 0;
int beatAvg = 0;

// SpO2 moving average
#define SPO2_SIZE 10
float spo2Values[SPO2_SIZE];
byte spo2Spot = 0;
float SpO2Avg = 0;

void setup() {
  Serial.begin(115200);
  Wire.begin(21, 22); // SDA=21, SCL=22

  // Initialize MAX30102
  if (!particleSensor.begin(Wire, I2C_SPEED_STANDARD)) {
    Serial.println("MAX30102 not found!");
    while (1);
  }
  particleSensor.setup();
  
  // Optimized LED brightness for most fingers
  particleSensor.setPulseAmplitudeRed(0x15);  
  particleSensor.setPulseAmplitudeIR(0x15);

  // Initialize DS18B20
  sensors.begin();
}

void loop() {
  long irValue = particleSensor.getIR();
  long redValue = particleSensor.getRed();

  // Check if finger is present (adjusted range)
  if (irValue > 15000 && irValue < 90000) { 

    // Heart rate detection
    if (checkForBeat(irValue)) {
      long delta = millis() - lastBeat;
      lastBeat = millis();
      float bpm = 60 / (delta / 1000.0);

      if (bpm > 1 && bpm < 200) {
        rates[rateSpot++] = (byte)bpm;
        rateSpot %= RATE_SIZE;

        // Average HR
        beatAvg = 0;
        for (byte i = 0; i < RATE_SIZE; i++)
          beatAvg += rates[i];
        beatAvg /= RATE_SIZE;
      }
    }

    // Approximate SpO2
    float ratio = (float)redValue / irValue;
    float rawSpO2 = 110 - 25 * ratio;

    // Moving average for SpO2
    spo2Values[spo2Spot++] = rawSpO2;
    spo2Spot %= SPO2_SIZE;
    float sum = 0;
    for (byte i = 0; i < SPO2_SIZE; i++)
      sum += spo2Values[i];
    SpO2Avg = sum / SPO2_SIZE;

  } else {
    beatAvg = 0;
    SpO2Avg = 0;
  }

  // Read temperature
  sensors.requestTemperatures();
  float tempC = sensors.getTempCByIndex(0);

  // Print single averaged output
  Serial.print("Heart Rate: "); Serial.print(beatAvg); Serial.print(" bpm | ");
  Serial.print("SpO2: "); Serial.print(SpO2Avg); Serial.print(" % | ");
  Serial.print("Temp: "); Serial.print(tempC); Serial.println(" Â°C");

  delay(1000); // 1-second update
}
