from flask import Flask, render_template, request, jsonify
import joblib
import numpy as np

app = Flask(__name__)

# ==============================
# Load all trained ML models
# ==============================
models = {
    "Logistic Regression": joblib.load("Logistic_Regression_model.pkl"),
    "Random Forest": joblib.load("Random_Forest_model.pkl"),
    "Decision Tree": joblib.load("Decision_Tree_model.pkl"),
    "SVM": joblib.load("SVM_model.pkl"),
    "KNN": joblib.load("KNN_model.pkl")
}

# Variables to store live sensor data
latest_sensor_data = {
    "Heart_Rate": None,
    "SpO2": None,
    "Body_Temperature": None
}

# ==============================
# Route 1: Main form page
# ==============================
@app.route("/", methods=["GET", "POST"])
def index():
    prediction_results = {}
    final_prediction = None

    if request.method == "POST":
        # Get form inputs (either from form or sensor)
        Age = float(request.form.get("Age", 0))
        Sex = 1 if request.form.get("Sex", "Male") == "Male" else 0
        Heart_Rate = float(request.form.get("Heart_Rate", latest_sensor_data["Heart_Rate"] or 0))
        SpO2 = float(request.form.get("SpO2", latest_sensor_data["SpO2"] or 0))
        Body_Temperature = float(request.form.get("Body_Temperature", latest_sensor_data["Body_Temperature"] or 0))
        Respiratory_Rate = float(request.form.get("Respiratory_Rate", 0))

        features = np.array([Age, Sex, Heart_Rate, SpO2, Body_Temperature, Respiratory_Rate]).reshape(1, -1)

        selected_models = request.form.getlist("models")
        votes = []

        for model_name in selected_models:
            model = models[model_name]
            result = model.predict(features)[0]
            prediction_results[model_name] = "ğŸš¨ Sepsis Detected" if result == 1 else "âœ… No Sepsis"
            votes.append(result)

        if votes:
            final_prediction = "ğŸš¨ Sepsis Detected" if sum(votes) > len(votes) / 2 else "âœ… No Sepsis"

    # Pass latest sensor data to form for auto-fill
    return render_template(
        "form.html",
        prediction_results=prediction_results,
        final_prediction=final_prediction,
        sensor_data=latest_sensor_data
    )


# ==============================
# Route 2: Arduino -> Flask Data Upload
# ==============================
@app.route("/upload", methods=["POST"])
def upload():
    try:
        data = request.get_json()
        latest_sensor_data["Heart_Rate"] = data.get("heart_rate")
        latest_sensor_data["SpO2"] = data.get("spo2")
        latest_sensor_data["Body_Temperature"] = data.get("temperature")

        print(f"ğŸ“¡ Received from Arduino â†’ HR: {latest_sensor_data['Heart_Rate']} | "
              f"SpO2: {latest_sensor_data['SpO2']} | Temp: {latest_sensor_data['Body_Temperature']}")

        return jsonify({"status": "success", "message": "Data received successfully"})
    except Exception as e:
        print("âŒ Error receiving data:", e)
        return jsonify({"status": "error", "message": str(e)})


# ==============================
# Run Flask server
# ==============================
if __name__ == "__main__":
    # Run on your local network so Arduino can access it
    app.run(host="0.0.0.0", port=5000, debug=True)
